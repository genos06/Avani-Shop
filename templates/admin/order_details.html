{% extends "admin/admin_base.html" %}

{% block title %}Order #{{ order.id }} Details{% endblock %}

{% block content %}
<div class="mb-4">
    <h2>Order #{{ order.id }} Details</h2>
    <p class="text-muted">View complete order information and update status</p>
</div>

<div class="row">
    <!-- Order Items -->
    <div class="col-md-8">
        <div class="content-card mb-4">
            <div class="content-card-header">
                <h4><i class="fa fa-box mr-2"></i> Order Items</h4>
            </div>
            
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.order_items %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="{{ url_for('static', filename=item.product.image_filename) }}" alt="{{ item.product.name }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; margin-right: 15px;">
                                    <strong>{{ item.product.name }}</strong>
                                </div>
                            </td>
                            <td>₹{{ "%.2f"|format(item.price) }}</td>
                            <td>{{ item.quantity }} kg</td>
                            <td><strong>₹{{ "%.2f"|format(item.get_subtotal()) }}</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-active">
                            <td colspan="3" class="text-right"><strong>Total Amount:</strong></td>
                            <td><strong style="font-size: 18px;">₹{{ "%.2f"|format(order.total_amount) }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Shipping Address -->
        <div class="content-card">
            <div class="content-card-header">
                <h4><i class="fa fa-map-marker-alt mr-2"></i> Shipping Address</h4>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> {{ order.first_name }} {{ order.last_name }}</p>
                    {% if order.company %}
                    <p><strong>Company:</strong> {{ order.company }}</p>
                    {% endif %}
                    <p><strong>Email:</strong> {{ order.email }}</p>
                    <p><strong>Phone:</strong> {{ order.phone }}</p>
                    {% if order.telephone %}
                    <p><strong>Telephone:</strong> {{ order.telephone }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <p><strong>Address:</strong> {{ order.address }}</p>
                    <p><strong>City:</strong> {{ order.city }}</p>
                    <p><strong>State:</strong> {{ order.state }}</p>
                    <p><strong>Country:</strong> {{ order.country }}</p>
                    {% if order.postcode %}
                    <p><strong>Postcode:</strong> {{ order.postcode }}</p>
                    {% endif %}
                </div>
            </div>
            {% if order.order_notes %}
            <hr>
            <p><strong>Order Notes:</strong></p>
            <p class="text-muted">{{ order.order_notes }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Order Status & Actions -->
    <div class="col-md-4">
        <div class="content-card mb-4">
            <div class="content-card-header">
                <h4><i class="fa fa-info-circle mr-2"></i> Order Info</h4>
            </div>
            <p><strong>Order Date:</strong><br>{{ order.created_at.strftime('%d %B %Y, %I:%M %p') }}</p>
            <p><strong>Customer:</strong><br>{{ order.user.username }} (ID: {{ order.user_id }})</p>
            <p>
                <strong>Current Status:</strong><br>
                {% if order.status == 'pending' %}
                    <span class="badge badge-warning badge-status">Pending</span>
                {% elif order.status == 'processing' %}
                    <span class="badge badge-info badge-status">Processing</span>
                {% elif order.status == 'completed' %}
                    <span class="badge badge-success badge-status">Completed</span>
                {% elif order.status == 'cancelled' %}
                    <span class="badge badge-danger badge-status">Cancelled</span>
                {% endif %}
            </p>
        </div>

        <div class="content-card">
            <div class="content-card-header">
                <h4><i class="fa fa-edit mr-2"></i> Update Status</h4>
            </div>
            <form method="POST" action="{{ url_for('admin_update_order_status', order_id=order.id) }}">
                <div class="form-group">
                    <label for="status"><strong>Change Status:</strong></label>
                    <select class="form-control" id="status" name="status" required>
                        <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                        <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-gradient btn-block">
                    <i class="fa fa-save mr-2"></i> Update Status
                </button>
            </form>

            <hr>

            <a href="{{ url_for('admin_orders') }}" class="btn btn-secondary btn-block">
                <i class="fa fa-arrow-left mr-2"></i> Back to Orders
            </a>

            <form method="POST" action="{{ url_for('admin_delete_order', order_id=order.id) }}" onsubmit="return confirm('Are you sure you want to delete this order? This action cannot be undone.');">
                <button type="submit" class="btn btn-danger btn-block mt-2">
                    <i class="fa fa-trash mr-2"></i> Delete Order
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
